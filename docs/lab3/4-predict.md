## 1. 静态预测方法

&emsp;&emsp;最简单的静态分支预测方法是预测分支指令总是跳转，或预测总是不跳转。显然，使用这种方法对不同的程序进行分支预测时，预测准确率会有很大差异。一种改进的预测方法是若分支指令是往回跳的就预测跳转，否则预测不跳转，这种方法对单循环的预测效果较好。

&emsp;&emsp;静态分支预测的优点是实现简单、硬件开销较小、预测速度较快，但预测准确度相对较低，不能满足通用处理器对性能日益增长的需求。

## 2. 动态预测方法

&emsp;&emsp;动态分支预测根据分支指令的过去表现来预测其将来的行为。如果分支行为发生变化，那么分支预测的结果也相应地发生改变。因此，动态分支预测与静态分支预测相比具有更好的预测准确率和适应性。

### 2.1 基于BHT的分支预测

&emsp;&emsp;基于BHT（Branch History Table）的分支预测方法使用分支历史表来记录分支指令的历史行为。BHT的基础结构如图3-21所示。

<center><img src = "../assets/3-21.png" width = 350></center>
<center>图3-21 基础BHT的结构</center>

&emsp;&emsp;其中，Tag字段类似于Cache的Tag，是指令地址的一部分；分支历史由若干个2bit饱和计数器组成。预测时，取分支指令的地址去查BHT的Tag字段，然后根据BHT当前行的分支历史，对分支的跳转方向进行预测。如果BHT只记录各分支指令最近1次的分支历史，则只需使用1bit的饱和计数器。理论上，可使用任意位宽的饱和计数器来记录分支历史。有研究表明，2bit饱和计数器的预测性能与更高位宽的预测性能差不多。因此在实践中，通常使用2bit饱和计数器。

&emsp;&emsp;基于2bit饱和计数器进行分支预测的原理如图3-22所示。

<center><img src = "../assets/3-22.png" width = 450></center>
<center>图3-22 基于2bit饱和计数器的分支预测</center>

&emsp;&emsp;完整的分支预测过程包含预测和更新2个步骤。预测时，用分支指令的地址查BHT，获得相应的饱和计数器值。若饱和计数器的最高位为1，预测分支跳转，否则预测分支不跳转。当分支指令的实际跳转方向被确定时，不管预测是否正确，都根据图3-22对BHT中的饱和计数器进行更新，从而达到动态调整分支预测结果的目的。

### 2.2 基于全局历史的分支预测

&emsp;&emsp;基于BHT的分支预测方法忽视了分支指令之间的关联性。为此，基于全局历史的分支预测方法在BHT的基础上增加了GHR（Global History Register，全局历史寄存器）来将所有分支指令关联起来。

&emsp;&emsp;基于全局历史的分支预测方法使用一个k比特的GHR来记录所有最近k条分支指令的历史跳转方向，并使用PHT（Pattern History Table，模式历史表）来记录各分支指令的分支历史。其中，PHT的结构类似于BHT。

&emsp;&emsp;预测时，首先将分支指令的地址和GHR进行异或，再用异或操作的结果来查PHT，然后根据PHT当前行的分支历史和分支目标地址，对该分支指令的分支跳转方向和分支目标地址进行预测，如图3-23所示。

<center><img src = "../assets/3-23.png" width = 520></center>
<center>图3-23 基于全局历史的分支预测</center>

&emsp;&emsp;当分支指令的实际跳转行为被确定时，GHR通过移位的方式进行更新——若指令跳转，则GHR = (GHR << 1) | 1，否则GHR = (GHR << 1) | 0。

### 2.3 基于局部历史的分支预测

&emsp;&emsp;基于全局历史的分支预测方法将所有分支指令都关联到一起。然而事实上，并非所有的分支指令都具有关联性。为此，基于局部历史的分支预测方法使用LHT（Local History Table，局部历史表）来代替全局历史预测中的GHR。

&emsp;&emsp;LHT一般具有64条记录，每条记录均包含Tag和局部转移历史2个字段。其中，Tag字段是分支指令地址的一部分，局部转移历史字段则是k比特的移位寄存器，其作用等同于GHR。

&emsp;&emsp;预测时，首先用分支指令的地址查LHT，得到分支指令的局部转移历史LHT[i]；然后将分支指令的地址和LHT[i]进行异或，再用异或操作的结果来查PHT；最后根据PHT当前行的分支历史和分支目标地址，对该分支指令的分支跳转方向和分支目标地址进行预测，如图3-24所示。

<center><img src = "../assets/3-24.png" width = 650></center>
<center>图3-24 基于局部历史的分支预测</center>

&emsp;&emsp;当分支指令的实际跳转行为被确定时，LHT[i]和GHR一样，也通过移位的方式进行更新——若指令跳转，则LHT[i] = (LHT[i] << 1) | 1，否则LHT[i] = (LHT[i] << 1) | 0。

&emsp;&emsp;添加了数据分支预测的数据通路框图如图3-25所示：

<center><img src = "../assets/3-25.png"></center>
<center>图3-25 增加分支预测的数据流图</center>

- RTL实现（IF/ID流水寄存器Flush操作）

<center><img src = "../assets/rtl5.png" width = 500></center>
