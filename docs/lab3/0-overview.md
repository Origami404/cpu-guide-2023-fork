## 1. 实验目的

&emsp;&emsp;（1）理解流水线CPU工作过程；

&emsp;&emsp;（2）熟悉miniRV-1指令集；

&emsp;&emsp;（3）掌握流水线CPU设计与实现方法。

&emsp;&emsp;

## 2. 实验内容

&emsp;&emsp;本实验要求同学们在单周期CPU的基础上，实现流水线CPU。实现要求如下：

- 五级流水线（至少）

- 哈佛结构，分开的指令与数据接口

- 32个32位整数寄存器

- 支持常规24条指令（可添加选做指令）

- 具有32bit数据、地址总线宽度

- 支持外部中断、异常处理（可选）

### 2.1 选做指令

#### 2.1.1 比较指令

SLT指令：将操作数寄存器rs1中的整数值与寄存器rs2中的整数值当作有符号数进行比较。如果rs1中的值小于rs2中的值，则结果为1，否则为0，写回寄存器rd中。
指令汇编格式：`slt rd, rs1, rs2`

SLTI指令：将操作数寄存器rs1中的整数值与12位立即数（进行符号位扩展）当作有符号数进行比较。如果rs1中的值小于立即数的值，则结果为1，否则为0，写回寄存器rd中。
指令汇编格式：`slti rd, rs1, imm[11:0]`

SLTU指令：将操作数寄存器rs1中的整数值与寄存器rs2中的整数值当作无符号数进行比较。如果rs1中的值小于rs2中的值，则结果为1，否则为0，写回寄存器rd中。
指令汇编格式：`sltu rd, rs1, rs2`

SLTIU指令：将操作数寄存器rs1中的整数值与12位立即数（进行符号位扩展）当作无符号数进行比较。如果rs1中的值小于立即数的值，则结果为1，否则为0，写回寄存器rd中。
指令汇编格式：`sltiu rd, rs1, imm[11:0]`

#### 2.1.2 加载存储指令

LB指令：从存储器中读回一个8位的数据，进行符号位扩展后写回寄存器rd中。
指令汇编格式：`lb rd, offset[11:0](rs1)`

LH指令：从存储器中读回一个16位的数据，进行符号位扩展后写回寄存器rd中。
指令汇编格式：`lh rd, offset[11:0](rs1)`

SB指令：将操作数寄存器rs2中的低8位数据，写回存储器中。
指令汇编格式：`sb rs2, offset[11:0](rs1)`

SH指令：将操作数寄存器rs2中的低16位数据，写回存储器中。
指令汇编格式：`sh rs2, offset[11:0](rs1)`

!!! Tips
    对于SB、SH指令，需要先读出对应地址的数据，然后替换掉需要存储的字节，再写入存储器。

#### 2.1.3 整数乘法指令

mul指令：将操作数寄存器rs1与rs2中的32位整数相乘，将结果的低32 位写回寄存器rd中。
指令汇编格式：`mul rd, rs1, rs2`

mulh指令：将操作数寄存器rs1与rs2中的32位整数相乘，其中rs1和rs2中的值都被当作有符号数，将结果的高32位写回寄存器rd中。
指令汇编格式：`mulh rd, rs1, rs2`

mulhu指令：将操作数寄存器rs1与rs2中的32 位整数相乘，其中rs1和rs2中的值都被当作无符号数，将结果的高32位写回寄存器rd中。
指令汇编格式：`mulhu rd, rs1, rs2`

mulhsu指令：将操作数寄存器rs1与rs2 中的32位整数相乘，其中rs1和rs2中的值分别被当作有符号数和无符号数，将结果的高32位写回寄存器rd中。
指令汇编格式：`mulhsu rd, rs1, rs2`

#### 2.1.4 整数除法指令

div指令：将操作数寄存器rs1与rs2中的32位整数相除，其中rs1和rs2 中的值都被当作有符号数，将除法所得的商写回寄存器rd中。
指令汇编格式：`div rd, rs1, rs2`

divu指令：将操作数寄存器rs1与rs2中的32位整数相除，其中rs1和rs2 中的值都被当作无符号数，将除法所得的商写回寄存器rd中。
指令汇编格式：`divu rd, rs1, rs2`

rem指令：将操作数寄存器rs1与rs2中的32位整数相除，其中rs1和rs2 中的值都被当作有符号数，将除法所得的余数写回寄存器rd中。
指令汇编格式：`rem rd, rsl, rs2`

remu指令：将操作数寄存器rs1与rs2中的32位整数相除，其中rs1和rs2中的值都被当作无符号数，将除法所得的余数写回寄存器rd中。
指令汇编格式：`remu rd, rsl, rs2`

#### 2.1.5 CSR指令

csrrw指令：将csr索引的CSR寄存器值读出，写回结果寄存器rd中。将操作数寄存器rsl 中的值写入csr 索引的CSR 寄存器中。
指令汇编格式：`csrrw rd, csr, rs1`

csrrs指令：将csr索引的CSR寄存器值读出，写回结果寄存器rd中。以操作数寄存器rs l中的值逐位作为参考，如果rs1中的值某个比特位为1，则将csr索引的CSR 寄存器中对应的比特位置为1，其他位则不受影响。
指令汇编格式：`csrrs rd, csr, rs1`

csrrc指令：将csr索引的CSR寄存器的值读出，写回结果寄存器rd中。以操作数寄存器rsl中的值逐位作为参考，如果rs1中的值某个比特位为1，则将csr索引的CSR寄存器中对应的比特位清为0，其他位则不受影响。
指令汇编格式：`csrrc rd, csr, rs1`
